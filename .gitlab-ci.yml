stages:
  - check
  - test
  - deploy

check:
  stage: check
  rules:
    - changes:
        - composer.json
  script:
    - bash .wex/script/ciCheck.sh
    - echo "COMPOSER_PACKAGE_DIR=${CI_PROJECT_DIR}" > ../.env.symfony-composer
  artifacts:
    reports:
      dotenv: .env.skip

test:
  stage: test
  rules:
    - changes:
        - composer.json
      if: '$SKIP_BUILD != "true"'
  needs:
    - check
  trigger:
      project: wexample/symfony-composer
      branch: master
      strategy: depend
  variables:
    COMPOSER_PACKAGE: $PROJECT_A_DIR

deploy:
  stage: deploy
  rules:
    - changes:
        - composer.json
      if: '$SKIP_BUILD != "true"'
  needs:
    - test
  script:
    - sudo mkdir tmp
    - sudo chown -R www-data:www-data tmp
    - cd tmp
    - sudo -u www-data git clone ${CI_REPOSITORY_URL} .
    - sudo -u www-data git remote add github git@github.com:wexample/symfony-api.git
    - VERSION=$(grep -oP '"version": "\K[^"]+' composer.json)
    - sudo -u www-data git tag v${VERSION} || true
    - sudo -u www-data git push origin
    - sudo -u www-data git push github
