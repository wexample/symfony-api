stages:
  - check
  - test
  - deploy

before_script:
  - export FILE_CHANGED=$(git diff --name-only HEAD HEAD~1 | grep composer.json || echo "false")

check:
  stage: check
  rules:
    - changes:
        - composer.json
  script:
    - bash .wex/script/ciCheck.sh
    - echo "COMPOSER_PACKAGE_DIR=${CI_PROJECT_DIR}" > ../.env.symfony-composer
  artifacts:
    reports:
      dotenv: .env.skip

test:
  stage: test
  rules:
    - if: '$FILE_CHANGED != "false" && $SKIP_BUILD != "true"'
  needs:
    - check
  trigger:
      project: wexample/symfony-composer
      branch: master
      strategy: depend
  variables:
    COMPOSER_PACKAGE: $PROJECT_A_DIR

deploy:
  stage: deploy
  rules:
    - if: '$FILE_CHANGED != "false" && $SKIP_BUILD != "true"'
  needs:
    - test
  script:
    - sudo mkdir tmp
    - sudo chown -R www-data:www-data tmp
    - cd tmp
    - sudo -u www-data git clone ssh://git@gitlab.wexample.com:4567/wexample/symfony-api.git .
    - sudo -u www-data git remote add github git@github.com:wexample/symfony-api.git
    - VERSION=$(python3 -c "import json; print(json.load(open('composer.json'))['version'])")
    - echo "Adding tag v${VERSION}"
    - sudo -u www-data git tag v${VERSION} || true
    - sudo -u www-data git push origin --tags
    - sudo -u www-data git push github --tags
